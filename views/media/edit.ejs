<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
</head>
<body>
  <h1><%= title %></h1>

  <form action="/media/<%= media._id %>?_method=PUT" method="POST">
    <div>
      <label for="title">Title:</label>
      <input type="text" id="title" name="title" value="<%= media.title %>">
    </div>

    <div>
      <label for="type">Type:</label>
      <select id="type" name="type">
        <option value="Video Game" <%= media.type == 'Video Game' ? 'selected' : '' %>>Video Game</option>
        <option value="TV Show" <%= media.type == 'TV Show' ? 'selected' : '' %>>TV Show</option>
        <option value="Film" <%= media.type == 'Film' ? 'selected' : '' %>>Film</option>
        <option value="Book" <%= media.type == 'Book' ? 'selected' : '' %>>Book</option>
        <option value="Sporting Event" <%= media.type == 'Sporting Event' ? 'selected' : '' %>>Sporting Event</option>
        <option value="Other" <%= media.type == 'Other' ? 'selected' : '' %>>Other</option>
      </select>
    </div>

    <div>
      <label for="year">Year of Release:</label>
      <input type="number" id="year" name="year" min="0" value="<%= media.year ? media.year : 0 %>">
    </div>

    <div>
      <label for="hasParts">Does this media have parts?</label>
      <input type="checkbox" id="hasParts" name="hasParts" <%= media.parts.length > 0 ? 'checked' : '' %>>
    </div>

    <div id="partsFields" style="display: <%= media.parts.length > 0 ? 'block' : 'none' %>">
      <label for="partDesignator">Part designator:</label>
      <select id="partDesignator" name="partDesignator">
        <option value="Chapter">Chapter</option>
        <option value="Episode">Episode</option>
        <option value="Level">Level</option>
        <option value="Part">Part</option>
        <option value="Custom">Custom</option>
        <option value="None">None</option>
      </select>

      <label for="customDesignator" style="display: <%= partDesignator === 'Custom' ? 'block' : 'none' %>;">Custom designator:</label>
      <input type="text" id="customDesignator" name="customDesignator" style="display: <%= partDesignator === 'Custom' ? 'block' : 'none' %>;" value="<%= customDesignator %>">

      <label for="numParts">Number of parts:</label>
      <input type="number" id="numParts" name="numParts" min="0" value="<%= numParts %>">

      <div id="partsContainer">
        <% for(let i = 0; i < media.parts.length; i++) { %>
          <input type="text" name="parts[<%= i %>]" value="<%= media.parts[i].title %>">
        <% } %>
      </div>
    </div>

    <button type="submit">Update Media</button>
  </form>

  <a href="/media/<%= media._id %>">Cancel</a>

  <script>
    const hasParts = document.querySelector('#hasParts');
    const partsFields = document.querySelector('#partsFields');
    const numParts = document.querySelector('#numParts');
    const partDesignator = document.querySelector('#partDesignator');
    const customDesignator = document.querySelector('#customDesignator');
    const partsContainer = document.querySelector('#partsContainer');

    hasParts.addEventListener('change', handleHasPartsChange);
    partDesignator.addEventListener('change', handlePartDesignatorChange);
    customDesignator.addEventListener('input', handleNumPartsChange);
    numParts.addEventListener('input', handleNumPartsChange);

    // Initialize part designator dropdown
    partDesignator.value = "<%= partDesignator %>";
    customDesignator.value = "<%= customDesignator %>";
    handlePartDesignatorChange();

    function handleHasPartsChange() {
      if (hasParts.checked) {
        partsFields.style.display = 'block';
      } else {
        partsFields.style.display = 'none';
        numParts.value = 0;
        partsContainer.innerHTML = '';
      }
    }

    function handlePartDesignatorChange() {
      if (partDesignator.value === 'Custom') {
        customDesignator.style.display = 'block';
      } else {
        customDesignator.style.display = 'none';
      }
      handleNumPartsChange();
    }

    function handleNumPartsChange() {
      partsContainer.innerHTML = ''; // Clear the parts container
      const num = numParts.value;
      let designator = partDesignator.value;
      if (designator === 'Custom') {
        designator = customDesignator.value;
      } else if (designator === 'None') {
        designator = '';
      }
      const existingPartNames = [...document.querySelectorAll('[name^="parts["]')].map(input => input.value);
      for (let i = 0; i < num; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `parts[${i}]`;
        input.value = existingPartNames[i] || (designator ? `${designator} ${i + 1}` : '');
        partsContainer.appendChild(input);
      }
    }
  </script>
</body>
</html>
